name: âš™ï¸ Deploy CDK

on:
  # âœ… workflow_call only - no workflow_dispatch
  # Cannot be triggered directly, only via pipeline.yml
  # which is only callable via orchestrator.yml
  # Full call chain: orchestrator â†’ pipeline â†’ deploy_cdk
  # Approval gate lives in orchestrator, so this is secure
  workflow_call:
    inputs:
      ag:
        description: Target account group
        required: true
        type: string

      environment:
        description: The environment level
        required: true
        type: string

      stack:
        description: The stack to deploy
        required: true
        type: string

      tag:
        description: Git tag to deploy
        required: true
        type: string

      diff:
        description: Run CDK diff?
        required: false
        type: boolean
        default: false

      destroy:
        description: Run CDK destroy?
        required: false
        type: boolean
        default: false

      deploy:
        description: Run CDK deploy?
        required: false
        type: boolean
        default: true

jobs:
  deploy:
    name: ${{ inputs.stack }} â†’ ${{ inputs.ag }}-${{ inputs.environment }}
    runs-on: ubuntu-latest
    # âœ… NO environment: here
    # Approval already granted at orchestrator approval-gate
    # This job is not directly triggerable (no workflow_dispatch above)
    # so there is no security hole from removing environment:

    permissions:
      id-token: write
      contents: write

    steps:
      - name: Show deployment info
        run: |
          echo "### ðŸ” Deployment Info" >> $GITHUB_STEP_SUMMARY
          echo "| Field       | Value                         |" >> $GITHUB_STEP_SUMMARY
          echo "| ----------- | ----------------------------- |" >> $GITHUB_STEP_SUMMARY
          echo "| AG          | ${{ inputs.ag }}              |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }}     |" >> $GITHUB_STEP_SUMMARY
          echo "| Stack       | ${{ inputs.stack }}           |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag         | ${{ inputs.tag }}             |" >> $GITHUB_STEP_SUMMARY
          echo "| Diff        | ${{ inputs.diff }}            |" >> $GITHUB_STEP_SUMMARY
          echo "| Destroy     | ${{ inputs.destroy }}         |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy      | ${{ inputs.deploy }}          |" >> $GITHUB_STEP_SUMMARY

      - name: Simulate CDK diff
        if: ${{ inputs.diff }}
        run: |
          echo "ðŸ“Š Running CDK diff"
          echo "   Stack : ${{ inputs.stack }}"
          echo "   AG    : ${{ inputs.ag }}"
          sleep 2
          echo "âœ… Diff complete"

      - name: Simulate CDK deploy
        if: ${{ inputs.deploy }}
        run: |
          echo "ðŸš€ Running CDK deploy"
          echo "   Stack       : ${{ inputs.stack }}"
          echo "   AG          : ${{ inputs.ag }}"
          echo "   Environment : ${{ inputs.environment }}"
          echo "   Tag         : ${{ inputs.tag }}"
          sleep 5
          echo "âœ… Deploy complete"

      - name: Simulate CDK destroy
        if: ${{ inputs.destroy }}
        run: |
          echo "ðŸ’¥ Running CDK destroy"
          echo "   Stack : ${{ inputs.stack }}"
          echo "   AG    : ${{ inputs.ag }}"
          sleep 2
          echo "âœ… Destroy complete"
