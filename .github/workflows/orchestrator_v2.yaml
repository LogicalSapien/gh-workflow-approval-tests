name: ðŸŽ¯ Deployment Orchestrator

run-name: >-
  Deploy ${{ github.event.inputs.tag }}
  to [${{ github.event.inputs.environments }}]
  across [${{ github.event.inputs.ags }}]
  by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      environments:
        description: "Select environments (comma-separated e.g. dev,tst,prd)"
        required: true
        default: "dev"
      ags:
        description: "Select Account Groups (comma-separated e.g. grp-alpha,grp-beta)"
        required: true
        default: "grp-alpha"
      exclude:
        description: "Exclude AG-env pairs (e.g. alpha-dev,beta-tst)"
        required: false
        default: ""
      tag:
        description: "Git Tag to deploy (e.g. v1.0.0)"
        required: true
        default: "v1.0.0"

jobs:
  # ---------------------------------------------------------------------------
  # STEP 1: Build the matrix from inputs
  # ---------------------------------------------------------------------------
  build-matrix:
    name: ðŸ§± Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
      needs_prod_gate: ${{ steps.generate.outputs.needs_prod_gate }}

    steps:
      - name: Generate deployment matrix
        id: generate
        shell: bash
        run: |
          set -euo pipefail

          readarray -t SELECTED_ENVS < <(echo "${{ github.event.inputs.environments }}" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          readarray -t SELECTED_AGS  < <(echo "${{ github.event.inputs.ags }}"          | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          readarray -t EXCLUDES      < <(echo "${{ github.event.inputs.exclude }}"      | tr ',' '\n' | sed '/^$/d')

          echo "Environments : ${SELECTED_ENVS[*]}"
          echo "AGs          : ${SELECTED_AGS[*]}"
          echo "Excludes     : ${EXCLUDES[*]:-none}"

          ENTRIES="[]"
          HAS_PROD=false

          for ag in "${SELECTED_AGS[@]}"; do
            # Derive short name: grp-alpha â†’ alpha
            short=$(echo "$ag" | sed 's/^grp-//')

            for env in "${SELECTED_ENVS[@]}"; do
              combined="${short}-${env}"

              excluded=false
              for ex in "${EXCLUDES[@]:-}"; do
                if [[ "$ex" == "$combined" ]]; then
                  excluded=true
                  break
                fi
              done

              if $excluded; then
                echo "Skipping excluded pair: $combined"
                continue
              fi

              if [[ "$env" == "prd" ]]; then
                HAS_PROD=true
              fi

              ENTRIES=$(echo "$ENTRIES" | jq \
                --arg ag "$ag" \
                --arg env "$env" \
                --arg short "$short" \
                --arg combined "$combined" \
                '. += [{"ag": $ag, "env": $env, "short": $short, "combined": $combined}]')
            done
          done

          COUNT=$(echo "$ENTRIES" | jq length)
          if [ "$COUNT" -eq 0 ]; then
            echo "âŒ ERROR: No matrix entries after filtering."
            exit 1
          fi

          MATRIX=$(echo "$ENTRIES" | jq -c '{ include: . }')

          echo "Matrix:"
          echo "$MATRIX" | jq .
          echo "Needs prod gate: $HAS_PROD"

          echo "matrix=$MATRIX"            >> "$GITHUB_OUTPUT"
          echo "needs_prod_gate=$HAS_PROD" >> "$GITHUB_OUTPUT"

      - name: Matrix summary
        run: |
          echo "### ðŸ§± Matrix Built" >> $GITHUB_STEP_SUMMARY
          echo "| Field        | Value                                   |" >> $GITHUB_STEP_SUMMARY
          echo "| ------------ | --------------------------------------- |" >> $GITHUB_STEP_SUMMARY
          echo "| Environments | ${{ github.event.inputs.environments }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AGs          | ${{ github.event.inputs.ags }}          |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag          | ${{ github.event.inputs.tag }}          |" >> $GITHUB_STEP_SUMMARY
          echo "| Exclude      | ${{ github.event.inputs.exclude }}      |" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # STEP 2: ONE approval gate before anything deploys
  # - prd included â†’ gates on 'prd' environment (protected, needs approval)
  # - no prd        â†’ gates on 'dev' environment (no protection, passes through)
  # ---------------------------------------------------------------------------
  approval-gate:
    name: ðŸ” Awaiting Approval
    needs: build-matrix
    runs-on: ubuntu-latest
    environment: ${{ needs.build-matrix.outputs.needs_prod_gate == 'true' && 'prd' || 'dev' }}

    steps:
      - name: Approval summary
        run: |
          echo "### ðŸ” Deployment Approved" >> $GITHUB_STEP_SUMMARY
          echo "| Field        | Value                                   |" >> $GITHUB_STEP_SUMMARY
          echo "| ------------ | --------------------------------------- |" >> $GITHUB_STEP_SUMMARY
          echo "| Approved by  | @${{ github.actor }}                    |" >> $GITHUB_STEP_SUMMARY
          echo "| Environments | ${{ github.event.inputs.environments }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AGs          | ${{ github.event.inputs.ags }}          |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag          | ${{ github.event.inputs.tag }}          |" >> $GITHUB_STEP_SUMMARY
          echo "| Approved at  | $(date -u '+%Y-%m-%d %H:%M UTC')        |" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # STEP 3: Matrix deploy - only starts after approval gate passes
  # Calls pipeline.yml which has NO workflow_dispatch
  # so it cannot be triggered directly, only via this orchestrator
  # ---------------------------------------------------------------------------
  deploy:
    name: ðŸš€ ${{ matrix.ag }} / ${{ matrix.env }}
    needs: [build-matrix, approval-gate]

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.build-matrix.outputs.matrix) }}

    concurrency:
      group: deploy-${{ matrix.ag }}-${{ matrix.env }}
      cancel-in-progress: false

    uses: ./.github/workflows/pipeline.yml

    with:
      ag: ${{ matrix.ag }}
      environment: ${{ matrix.env }}
      tag: ${{ github.event.inputs.tag }}

    secrets: inherit
    
