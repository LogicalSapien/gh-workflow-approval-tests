name: ðŸŽ¯ Deployment Orchestrator

run-name: >-
  Deploy ${{ github.event.inputs.tag }}
  to [${{ github.event.inputs.environments }}]
  across [${{ github.event.inputs.ags }}]
  by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      environments:
        description: "Environments (comma-separated e.g. dev,tst,prd)"
        required: true
        default: "dev"
      ags:
        description: "Account Groups (comma-separated e.g. grp-alpha,grp-beta)"
        required: true
        default: "grp-alpha"
      exclude:
        description: "Exclude AG-env pairs (e.g. alpha-dev,beta-tst)"
        required: false
        default: ""
      tag:
        description: "Git Tag to deploy (e.g. v1.0.0)"
        required: true
        default: "v1.0.0"

jobs:
  # ---------------------------------------------------------------------------
  # STEP 1: Validate inputs and decide gate environment
  # ---------------------------------------------------------------------------
  prepare:
    name: ðŸ§± Prepare
    runs-on: ubuntu-latest
    outputs:
      gate_env: ${{ steps.prepare.outputs.gate_env }}
      pairs: ${{ steps.prepare.outputs.pairs }}

    steps:
      - name: Parse inputs and determine gate
        id: prepare
        shell: bash
        run: |
          set -euo pipefail

          readarray -t SELECTED_ENVS < <(echo "${{ github.event.inputs.environments }}" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          readarray -t SELECTED_AGS  < <(echo "${{ github.event.inputs.ags }}"          | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          readarray -t EXCLUDES      < <(echo "${{ github.event.inputs.exclude }}"      | tr ',' '\n' | sed '/^$/d')

          echo "Environments : ${SELECTED_ENVS[*]}"
          echo "AGs          : ${SELECTED_AGS[*]}"
          echo "Excludes     : ${EXCLUDES[*]:-none}"

          GATE_ENV="dev"
          PAIRS="[]"

          for ag in "${SELECTED_AGS[@]}"; do
            short=$(echo "$ag" | sed 's/^grp-//')

            for env in "${SELECTED_ENVS[@]}"; do
              combined="${short}-${env}"

              excluded=false
              for ex in "${EXCLUDES[@]:-}"; do
                if [[ "$ex" == "$combined" ]]; then
                  excluded=true
                  break
                fi
              done

              if $excluded; then
                echo "Skipping: $combined"
                continue
              fi

              # Escalate gate
              if [[ "$env" == "prd" ]]; then
                GATE_ENV="prd"
              elif [[ "$env" == "tst" && "$GATE_ENV" != "prd" ]]; then
                GATE_ENV="tst"
              fi

              PAIRS=$(echo "$PAIRS" | jq \
                --arg ag "$ag" \
                --arg env "$env" \
                --arg combined "$combined" \
                '. += [{"ag": $ag, "env": $env, "combined": $combined}]')
            done
          done

          COUNT=$(echo "$PAIRS" | jq length)
          if [ "$COUNT" -eq 0 ]; then
            echo "âŒ ERROR: No AG-env pairs after filtering."
            exit 1
          fi

          echo "Pairs to deploy:"
          echo "$PAIRS" | jq .
          echo "Gate environment: $GATE_ENV"

          # Pass pairs as a JSON string so the deploy job can loop over them
          PAIRS_COMPACT=$(echo "$PAIRS" | jq -c .)

          echo "gate_env=$GATE_ENV"      >> "$GITHUB_OUTPUT"
          echo "pairs=$PAIRS_COMPACT"    >> "$GITHUB_OUTPUT"

      - name: Prepare summary
        run: |
          echo "### ðŸ§± Deployment Prepared" >> $GITHUB_STEP_SUMMARY
          echo "| Field        | Value                                   |" >> $GITHUB_STEP_SUMMARY
          echo "| ------------ | --------------------------------------- |" >> $GITHUB_STEP_SUMMARY
          echo "| Environments | ${{ github.event.inputs.environments }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AGs          | ${{ github.event.inputs.ags }}          |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag          | ${{ github.event.inputs.tag }}          |" >> $GITHUB_STEP_SUMMARY
          echo "| Exclude      | ${{ github.event.inputs.exclude }}      |" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # STEP 2: ONE approval gate
  # Entire workflow stops here until approved
  # gate_env is set by bash above so no fragile expression
  # ---------------------------------------------------------------------------
  approval-gate:
    name: ðŸ” Approval Gate [${{ needs.prepare.outputs.gate_env }}]
    needs: prepare
    runs-on: ubuntu-latest
    environment: ${{ needs.prepare.outputs.gate_env }}

    steps:
      - name: Approval summary
        run: |
          echo "### ðŸ” Deployment Approved" >> $GITHUB_STEP_SUMMARY
          echo "| Field        | Value                                   |" >> $GITHUB_STEP_SUMMARY
          echo "| ------------ | --------------------------------------- |" >> $GITHUB_STEP_SUMMARY
          echo "| Gate env     | ${{ needs.prepare.outputs.gate_env }}   |" >> $GITHUB_STEP_SUMMARY
          echo "| Approved by  | @${{ github.actor }}                    |" >> $GITHUB_STEP_SUMMARY
          echo "| Environments | ${{ github.event.inputs.environments }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AGs          | ${{ github.event.inputs.ags }}          |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag          | ${{ github.event.inputs.tag }}          |" >> $GITHUB_STEP_SUMMARY
          echo "| Approved at  | $(date -u '+%Y-%m-%d %H:%M UTC')        |" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # STEP 3: ONE deploy job that loops all AG+env pairs
  # No matrix = no matrix-expanded approval gates
  # Each pair calls the pipeline reusable workflow via gh cli
  # 
  # NOTE: Because reusable workflows cannot be called in a bash loop,
  # we inline the deployment logic here and call deploy_cdk.yml
  # steps directly. This is the tradeoff vs matrix.
  # ---------------------------------------------------------------------------
  deploy:
    name: ðŸš€ Deploy All
    needs: [prepare, approval-gate]
    runs-on: ubuntu-latest
    # No environment: here - approval already done above

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy all AG-env pairs
        shell: bash
        env:
          PAIRS: ${{ needs.prepare.outputs.pairs }}
          TAG:   ${{ github.event.inputs.tag }}
        run: |
          set -euo pipefail

          echo "$PAIRS" | jq -c '.[]' | while IFS= read -r pair; do
            AG=$(echo "$pair"       | jq -r '.ag')
            ENV=$(echo "$pair"      | jq -r '.env')
            COMBINED=$(echo "$pair" | jq -r '.combined')

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸš€ Deploying: $COMBINED (tag: $TAG)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            echo ""
            echo "ðŸ—ï¸  [Core Stack] $AG / $ENV"
            # ------------------------------------------------------------------
            # REPLACE THIS with your actual CDK deploy command
            # e.g. cdk deploy --app "python src/python/cdk/core/app.py" ...
            # ------------------------------------------------------------------
            echo "   Simulating core stack deploy for $AG / $ENV"
            sleep 2
            echo "   âœ… Core stack done"

            echo ""
            echo "ðŸ“¦  [App Stack] $AG / $ENV"
            # ------------------------------------------------------------------
            # REPLACE THIS with your actual CDK deploy command
            # e.g. cdk deploy --app "python src/python/cdk/$AG/app.py" ...
            # ------------------------------------------------------------------
            echo "   Simulating app stack deploy for $AG / $ENV"
            sleep 2
            echo "   âœ… App stack done"

            echo ""
            echo "ðŸ§ª  [Smoke Tests] $AG / $ENV"
            # ------------------------------------------------------------------
            # REPLACE THIS with your actual smoke test command
            # e.g. cd tests/python/smoke && uv run pytest -v
            # ------------------------------------------------------------------
            echo "   Simulating smoke tests for $AG / $ENV"
            sleep 1
            echo "   âœ… Smoke tests passed"

            echo ""
            echo "âœ…  $COMBINED complete"
            echo ""

          done

      - name: Deployment summary
        if: always()
        env:
          PAIRS: ${{ needs.prepare.outputs.pairs }}
        run: |
          echo "### ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| AG-Env | Tag |" >> $GITHUB_STEP_SUMMARY
          echo "| ------ | --- |" >> $GITHUB_STEP_SUMMARY
          echo "$PAIRS" | jq -r '.[] | "| \(.combined) | ${{ github.event.inputs.tag }} |"' >> $GITHUB_STEP_SUMMARY
