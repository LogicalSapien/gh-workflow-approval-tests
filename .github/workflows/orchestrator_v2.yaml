name: ðŸŽ¯ Deployment Orchestrator

run-name: >-
  Deploy ${{ github.event.inputs.tag }}
  to [${{ github.event.inputs.environments }}]
  across [${{ github.event.inputs.ags }}]
  by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      environments:
        description: "Select environments (comma-separated e.g. dev,tst,prd)"
        required: true
        default: "dev"
      ags:
        description: "Select Account Groups (comma-separated e.g. grp-alpha,grp-beta,grp-gamma)"
        required: true
        default: "grp-alpha"
      exclude:
        description: "Exclude AG-env pairs (e.g. alpha-dev,beta-tst)"
        required: false
        default: ""
      tag:
        description: "Git Tag to deploy (e.g. v1.0.0)"
        required: true
        default: "v1.0.0"

jobs:
  # ---------------------------------------------------------------------------
  # STEP 1: Build matrix from inputs
  # Mirrors your real orchestrator build-matrix job
  # but reads from inputs instead of a JSON registry file
  # ---------------------------------------------------------------------------
  build-matrix:
    name: ðŸ§± Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
      gate_env: ${{ steps.generate.outputs.gate_env }}

    steps:
      - name: Generate deployment matrix
        id: generate
        shell: bash
        run: |
          set -euo pipefail

          readarray -t SELECTED_ENVS < <(echo "${{ github.event.inputs.environments }}" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          readarray -t SELECTED_AGS  < <(echo "${{ github.event.inputs.ags }}"          | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          readarray -t EXCLUDES      < <(echo "${{ github.event.inputs.exclude }}"      | tr ',' '\n' | sed '/^$/d')

          echo "Environments : ${SELECTED_ENVS[*]}"
          echo "AGs          : ${SELECTED_AGS[*]}"
          echo "Excludes     : ${EXCLUDES[*]:-none}"

          ENTRIES="[]"
          GATE_ENV="dev"

          for ag in "${SELECTED_AGS[@]}"; do
            # Derive short name: grp-alpha â†’ alpha
            short=$(echo "$ag" | sed 's/^grp-//')

            for env in "${SELECTED_ENVS[@]}"; do
              combined="${short}-${env}"

              # Check exclusions
              excluded=false
              for ex in "${EXCLUDES[@]:-}"; do
                if [[ "$ex" == "$combined" ]]; then
                  excluded=true
                  break
                fi
              done

              if $excluded; then
                echo "Skipping excluded pair: $combined"
                continue
              fi

              # with this:
              if [[ "$env" == "prd" || "$env" == "prod" ]]; then
                GATE_ENV="prd"
              elif [[ ( "$env" == "tst" || "$env" == "tst" ) && "$GATE_ENV" != "prd" ]]; then
                GATE_ENV="tst"
              fi

              ENTRIES=$(echo "$ENTRIES" | jq \
                --arg ag "$ag" \
                --arg env "$env" \
                --arg short "$short" \
                --arg combined "$combined" \
                '. += [{"ag": $ag, "env": $env, "short": $short, "combined": $combined}]')
            done
          done

          COUNT=$(echo "$ENTRIES" | jq length)
          if [ "$COUNT" -eq 0 ]; then
            echo "âŒ ERROR: No matrix entries after filtering."
            exit 1
          fi

          MATRIX=$(echo "$ENTRIES" | jq -c '{ include: . }')

          echo "Matrix:"
          echo "$MATRIX" | jq .
          echo "Gate environment: $GATE_ENV"

          echo "matrix=$MATRIX"     >> "$GITHUB_OUTPUT"
          echo "gate_env=$GATE_ENV" >> "$GITHUB_OUTPUT"

      - name: Matrix summary
        run: |
          echo "### ðŸ§± Matrix Built" >> $GITHUB_STEP_SUMMARY
          echo "| Field        | Value                                   |" >> $GITHUB_STEP_SUMMARY
          echo "| ------------ | --------------------------------------- |" >> $GITHUB_STEP_SUMMARY
          echo "| Environments | ${{ github.event.inputs.environments }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AGs          | ${{ github.event.inputs.ags }}          |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag          | ${{ github.event.inputs.tag }}          |" >> $GITHUB_STEP_SUMMARY
          echo "| Exclude      | ${{ github.event.inputs.exclude }}      |" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # STEP 2: ONE approval gate
  # gate_env is set explicitly in bash above - no fragile ternary expression
  # dev/tst = no protection rules = passes straight through
  # prd     = required reviewer   = pauses and waits for approval
  # ---------------------------------------------------------------------------
  approval-gate:
    name: ðŸ” Approval Gate [${{ needs.build-matrix.outputs.gate_env }}]
    needs: build-matrix
    runs-on: ubuntu-latest
    environment: ${{ needs.build-matrix.outputs.gate_env }}

    steps:
      - name: Approval summary
        run: |
          echo "### ðŸ” Deployment Approved" >> $GITHUB_STEP_SUMMARY
          echo "| Field        | Value                                   |" >> $GITHUB_STEP_SUMMARY
          echo "| ------------ | --------------------------------------- |" >> $GITHUB_STEP_SUMMARY
          echo "| Gate env     | ${{ needs.build-matrix.outputs.gate_env }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Approved by  | @${{ github.actor }}                    |" >> $GITHUB_STEP_SUMMARY
          echo "| Environments | ${{ github.event.inputs.environments }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AGs          | ${{ github.event.inputs.ags }}          |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag          | ${{ github.event.inputs.tag }}          |" >> $GITHUB_STEP_SUMMARY
          echo "| Approved at  | $(date -u '+%Y-%m-%d %H:%M UTC')        |" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # STEP 3: Matrix deploy
  # All N jobs start in parallel after the single approval gate passes
  # Calls pipeline.yml which has NO workflow_dispatch
  # ---------------------------------------------------------------------------
  deploy:
    name: ðŸš€ ${{ matrix.ag }} / ${{ matrix.env }}
    needs: [build-matrix, approval-gate]

    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.build-matrix.outputs.matrix) }}

    concurrency:
      group: deploy-${{ matrix.ag }}-${{ matrix.env }}
      cancel-in-progress: false

    uses: ./.github/workflows/pipeline.yml

    with:
      ag: ${{ matrix.ag }}
      environment: ${{ matrix.env }}
      tag: ${{ github.event.inputs.tag }}

    secrets: inherit
