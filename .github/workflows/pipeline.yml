name: ðŸ”§ Pipeline

run-name: >-
  Deploy ${{ inputs.tag }}
  to ${{ inputs.ag }}-${{ inputs.environment }}
  by @${{ github.actor }}

on:
  # -----------------------------------------------------------------------
  # workflow_call ONLY - no workflow_dispatch
  # This mirrors what your deploy_release_aws_account.yaml should look like
  # Nobody can trigger this directly from the GitHub UI
  # The only way in is via orchestrator.yml
  # This is what makes removing environment: from deploy_cdk.yml safe
  # -----------------------------------------------------------------------
  workflow_call:
    inputs:
      ag:
        description: Account group to deploy to
        required: true
        type: string
      environment:
        description: Target environment
        required: true
        type: string
      tag:
        description: Git tag to deploy
        required: true
        type: string

concurrency:
  group: pipeline-${{ inputs.ag }}-${{ inputs.environment }}
  cancel-in-progress: false

jobs:

  # Mirrors your deploy-core job
  deploy-core:
    name: ðŸ—ï¸ Core [${{ inputs.ag }}-${{ inputs.environment }}]
    uses: ./.github/workflows/deploy_cdk.yml
    with:
      # mirrors your real inputs exactly
      cdk_app_directory: src/cdk/core/app.py
      cdk_stack: core-stack/**
      environment: ${{ inputs.environment }}
      ag: ${{ inputs.ag }}
      aws_role: core-build-role
      cdk_config: main_config.yaml
      diff: false
      destroy: false
      deploy: true
      github_ref: ${{ inputs.tag }}
    secrets: inherit

  # Mirrors your deploy-app job
  deploy-app:
    name: ðŸ“¦ App [${{ inputs.ag }}-${{ inputs.environment }}]
    needs: deploy-core
    uses: ./.github/workflows/deploy_cdk.yml
    with:
      cdk_app_directory: src/cdk/${{ inputs.ag }}/app.py
      cdk_stack: app-stack/**
      environment: ${{ inputs.environment }}
      ag: ${{ inputs.ag }}
      aws_role: ${{ inputs.ag }}-build-role
      cdk_config: main_config.yaml
      diff: false
      destroy: false
      deploy: true
      github_ref: ${{ inputs.tag }}
    secrets: inherit

  # Mirrors your smoke-tests job
  smoke-tests:
    name: ðŸ§ª Smoke Tests [${{ inputs.ag }}-${{ inputs.environment }}]
    needs: deploy-app
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag }}

      - name: Simulate AWS credentials
        run: |
          echo "ðŸ”‘ Configuring AWS credentials"
          echo "   Role   : ${{ inputs.ag }}-build-role"
          echo "   Region : us-east-1"
          sleep 1
          echo "âœ… AWS credentials configured"

      - name: Run smoke tests
        run: |
          echo "ðŸ§ª Running smoke tests"
          echo "   AG          : ${{ inputs.ag }}"
          echo "   Environment : ${{ inputs.environment }}"
          echo "   Tag         : ${{ inputs.tag }}"
          sleep 3
          echo "âœ… Smoke tests passed"

  # Mirrors your post-deploy job
  # -----------------------------------------------------------------------
  # NOTE: NO environment: here
  # Your real post-deploy has environment: ${{ inputs.environment }}
  # That is the second place causing extra approval prompts
  # Removing it here is safe because approval already happened
  # in the orchestrator approval-gate job
  # -----------------------------------------------------------------------
  post-deploy:
    name: âœ… Post Deploy [${{ inputs.ag }}-${{ inputs.environment }}]
    needs: smoke-tests
    runs-on: ubuntu-latest
    outputs:
      env_name: ${{ steps.env.outputs.env_name }}
    steps:
      - id: env
        name: Compute environment name
        run: |
          CLEANED="${{ inputs.ag }}"
          CLEANED="${CLEANED#grp-}"
          echo "env_name=$CLEANED-${{ inputs.environment }}" >> $GITHUB_OUTPUT

      - name: Save deployment version
        run: |
          echo "ðŸ’¾ Saving deployment record"
          echo "   Version : ${{ inputs.tag }}"
          echo "   AG      : ${{ inputs.ag }}"
          echo "   Env     : ${{ inputs.environment }}"
          sleep 1

      - name: Post deploy summary
        run: |
          echo "### âœ… Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "| Field       | Value                             |" >> $GITHUB_STEP_SUMMARY
          echo "| ----------- | --------------------------------- |" >> $GITHUB_STEP_SUMMARY
          echo "| AG          | ${{ inputs.ag }}                  |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }}         |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag         | ${{ inputs.tag }}                 |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed at | $(date -u '+%Y-%m-%d %H:%M UTC') |" >> $GITHUB_STEP_SUMMARY
