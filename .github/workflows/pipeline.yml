name: ðŸ”§ Pipeline

on:
  # âœ… workflow_call only - no workflow_dispatch
  # This means nobody can trigger this directly
  # The only way in is via orchestrator.yml
  # Therefore removing environment: from deploy_cdk.yml is safe
  # because the only path to deploy_cdk goes through the orchestrator gate
  workflow_call:
    inputs:
      ag:
        required: true
        type: string
      environment:
        required: true
        type: string
      tag:
        required: true
        type: string

concurrency:
  group: pipeline-${{ inputs.ag }}-${{ inputs.environment }}
  cancel-in-progress: false

jobs:

  deploy-core:
    name: ðŸ—ï¸ Core [${{ inputs.ag }}-${{ inputs.environment }}]
    uses: ./.github/workflows/deploy_cdk.yml
    with:
      ag: ${{ inputs.ag }}
      environment: ${{ inputs.environment }}
      stack: "core-stack"
      tag: ${{ inputs.tag }}
      deploy: true
      diff: false
      destroy: false
    secrets: inherit

  deploy-app:
    name: ðŸ“¦ App [${{ inputs.ag }}-${{ inputs.environment }}]
    needs: deploy-core
    uses: ./.github/workflows/deploy_cdk.yml
    with:
      ag: ${{ inputs.ag }}
      environment: ${{ inputs.environment }}
      stack: "app-stack"
      tag: ${{ inputs.tag }}
      deploy: true
      diff: false
      destroy: false
    secrets: inherit

  smoke-tests:
    name: ðŸ§ª Smoke Tests [${{ inputs.ag }}-${{ inputs.environment }}]
    needs: deploy-app
    runs-on: ubuntu-latest
    steps:
      - name: Run smoke tests
        run: |
          echo "ðŸ§ª Running smoke tests"
          echo "   AG          : ${{ inputs.ag }}"
          echo "   Environment : ${{ inputs.environment }}"
          echo "   Tag         : ${{ inputs.tag }}"
          sleep 3
          echo "âœ… Smoke tests passed"

  post-deploy:
    name: âœ… Post Deploy [${{ inputs.ag }}-${{ inputs.environment }}]
    needs: smoke-tests
    runs-on: ubuntu-latest
    # âœ… prd-internal has NO protection rules
    # Used only for deployment tracking in GitHub UI
    # Real protection already happened at approval-gate in orchestrator
    environment: ${{ inputs.environment == 'prd' && 'prd-internal' || inputs.environment }}
    outputs:
      env_name: ${{ steps.env.outputs.env_name }}
    steps:
      - id: env
        name: Compute environment name
        run: |
          CLEANED="${{ inputs.ag }}"
          CLEANED="${CLEANED#grp-}"
          echo "env_name=$CLEANED-${{ inputs.environment }}" >> $GITHUB_OUTPUT

      - name: Post deploy summary
        run: |
          echo "### âœ… Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "| Field       | Value                         |" >> $GITHUB_STEP_SUMMARY
          echo "| ----------- | ----------------------------- |" >> $GITHUB_STEP_SUMMARY
          echo "| AG          | ${{ inputs.ag }}              |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }}     |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag         | ${{ inputs.tag }}             |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed at | $(date -u '+%Y-%m-%d %H:%M UTC') |" >> $GITHUB_STEP_SUMMARY
